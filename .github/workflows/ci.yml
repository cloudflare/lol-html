name: CI

on:
  pull_request:
  push:
    branches:
      - master

env:
  RUSTFLAGS: -Dwarnings
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0 # makes cache smaller
  CARGO_PROFILE_DEV_DEBUG: 0

jobs:
  clippy:
    name: Clipy and format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - name: Check format
        run: cargo fmt -- --check
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          key: index-${{ hashFiles('Cargo.toml') }}
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
      - name: Fetch dependencies
        run: cargo fetch
      - name: Cache target directory
        uses: actions/cache@v4
        with:
          key: clippy-${{ hashFiles('Cargo.lock') }}
          path: target
      - name: Run clippy
        run: cargo clippy --all --all-targets
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          key: index-${{ hashFiles('Cargo.toml') }}
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
      - name: Fetch dependencies
        run: cargo fetch
      - name: Cache target directory
        uses: actions/cache@v4
        with:
          key: target-${{ hashFiles('Cargo.lock') }}
          path: target
      - name: Run Rust tests
        run: scripts/test.sh
